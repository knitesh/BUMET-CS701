<!DOCTYPE html>
<html>
  <head>
    <title>Compute Workers</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../materialize.min.css" />
    <style>
      #map {
        min-height: 400px;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-wrapper">
        <a href="#" class="brand-logo">Kumar Nitesh</a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
          <li><a href="../index.html">Home</a></li>
          <li>
            <a href="./LocationTracker.html">Geolocation</a>
          </li>
          <li><a href="./partyWise.html">LocalStorage</a></li>
          <li>
            <a href="./computerWorkers.html">Webworkers</a>
          </li>
        </ul>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col m6 s12">
          <ul class="collection with-header" id="message">
            <li class="collection-header" id="status">
              Posting Message to Worker
            </li>
          </ul>
        </div>
        <div class="col m6 s12">
          <ul class="collection with-header" id="result">
            <li class="collection-header" id="status">
              Receiving Response from worker
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- <script src="./computeWorker.js"></script> -->
    <script>
      (function() {
        // key to store data in localstorage
        const localstoragekey = `knitesh-worker-example`;
        // get hooks to html element
        const messageEl = document.getElementById("message");
        const resultEl = document.getElementById("result");

        // function to display the reecived response
        const displayResult = response => {
          // retrieve the data from response
          const result = response.data;
          // get the stored data from localstorage and parse back into JSON
          const storedData = JSON.parse(localStorage.getItem(localstoragekey));

          // if we already have data, push  new result into it else add result
          // directly to localstorage in a string format
          if (storedData) {
            storedData.push(result);
            localStorage.setItem(localstoragekey, JSON.stringify(storedData));
          } else {
            localStorage.setItem(localstoragekey, JSON.stringify([result]));
          }

          // prepare text to display on interface
          const resultText = `<li class="collection-item ">
              ${JSON.stringify(result)} 
            </li>`;
          // update the interface
          resultEl.innerHTML += resultText;
        };
        // function to log error in the dev console
        const displayError = err => {
          console.error("error received from workerFor => ", err);
        };

        // check if browser supports Worker api
        if (window.Worker) {
          //let clean up localstorage first
          localStorage.removeItem(localstoragekey);

          // default values
          let startNumber = 1;
          let endNumber = 1000;
          const numOfWorker = 5;

          // loop through and create 5 worker passing (1,1000),(1001,2000)... and so on
          for (let count = 1; count <= numOfWorker; count++) {
            const worker = new Worker("computeWorker.js");
            // post message to work
            worker.postMessage({ startNumber, endNumber });
            // listne for message from worker
            worker.addEventListener("message", displayResult);
            // listen to error event of worker
            worker.addEventListener("error", displayError);
            // prepare text to display on interface
            const message = `<li class="collection-item ">
              ${JSON.stringify({ startNumber, endNumber })}
            </li>`;
            let messageText = messageEl.innerHTML;
            // update interface
            messageEl.innerHTML = messageText + message;
            // increment start and end number
            startNumber += 1000;
            endNumber += 1000;
          }
        } else {
          console.log("Your browser doesn't support web workers.");
        }
      })();
    </script>
  </body>
</html>
